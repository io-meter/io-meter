<!DOCTYPE HTML>
<html>



<head>
  <meta charset="utf-8">

  <meta name="msapplication-TileColor" content="#000000">
  <meta name="msapplication-TileImage" content="/favicon/favicon144.png">

  <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/favicon/favicon152.png">
  <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/favicon/favicon120.png">
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicon/favicon144.png">
  <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/favicon/favicon72.png">

  
  <title>Let Rocket Fly | IO-meter</title>
  <meta name="author" content="Chase Zhang">
  
  <meta name="description" content="最近完成了我第一个相对完整的 WebGL 页面 (点这里)，
主要内容是一只可以旋转交互的小火箭。这篇文章就主要记录一下这个小项目的制作
过程。">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Let Rocket Fly"/>
  <meta property="og:site_name" content="IO-meter"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link rel="alternate" href="/atom.xml" title="IO-meter" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <script type="text/javascript" src="/js/retina.min.js"></script>
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-48012866-2', 'io-meter.com');
  ga('send', 'pageview');
</script>

</head>

<body>
<div id="banner">
    <div class="wrapper">
        <header>
            <div id="header" class="simple" >
<nav id="main-nav">
    <ul class="alignright">
        
        <li><a href="/">Home</a></li>
        
        <li><a href="/archives">Archives</a></li>
        
        <li><a href="http://chasezhang.me">About</a></li>
        
    </ul>
    <div class="clearfix"></div>
</nav>

  <h1 class="main"><a href="/">
  <img src="/img/logo.png" alt="IO-meter" id="logo" /></a></h1>
  <h2 class="main">Programic Creativity</h2>
  <h1 class="alt">
      <a href="/">IO METER</a>
  </h1>
  <div class="clearfix"></div>
</div>

        </header>
    </div>
</div>
<div id="content" class="wrapper">
    <div id="articles"><h2 class="subtitle article-title">Article</h2>
<article class="post title-article full-article">
  <div class="post-content">
    <header>
      
    <h1 class="title"><a href="/2014/04/05/let-rocket-fly/" target="_blank">Let Rocket Fly</a></h1>


      
        <time datetime="2014-04-05T06:53:12.000Z">Apr 5 2014</time>
      
    </header>
    <div class="entry">
      <p>最近完成了我第一个相对完整的 WebGL 页面 <a href="http://sjtug.github.io" target="_blank">(点这里)</a>，
主要内容是一只可以旋转交互的小火箭。这篇文章就主要记录一下这个小项目的制作
过程。</p>
<a id="more"></a>

<h2>Logo 设计</h2>
<p>这个项目是作为我们新近成立的一个同好会类型的组织 SJTUG 的第一个页面。在
开始制作时，对于作为页面主题的组织 Logo 其实还没有什么想法。偶然的情况下
发现小火箭这种形象很适合作为 Logo，适当调整一下，做一个交互的东西也比较方便，
因此就果断的朝这个方向构思了。</p>
<p>首先是在矢量绘图软件中大概的完成 Logo 的平面形象，主要是从 Google Image 上搜索
出来一些已有的图案作为参考。用 CorelDRAW 绘制的 Logo 成图如下。</p>
<p><img src="/img/posts/Rocket480.png" alt="rocket" title="Rocket Logo"></p>
<p>在这里，记得要将 Logo 输出成不同的分辨率，以便于适配 Retina 的屏幕分辨率，
对于移动设备和不支持 WebGL 的浏览器，应该要能 fallback 到静态的图片。
支持 Retina 显示图片的话，可以用 <a href="http://retinajs.com" target="_blank">retina.js</a>，也可以像
我这里一样使用 CSS 。一个可以支持大多数设备的 CSS Media 选择代码如下所示：</p>
<figure class="highlight lang-css"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre><span class="at_rule">@<span class="keyword">media</span>	only screen and (-webkit-min-device-pixel-ratio: <span class="number">1.3</span>),
only screen and (-o-min-device-pixel-ratio: <span class="number">13</span>/<span class="number">10</span>),
only screen and (min-resolution: <span class="number">120</span>dpi)
</span>{
    <span class="comment">/* Things for retina display */</span>
    <span class="id">#logo</span> <span class="rules">{
        <span class="rule"><span class="attribute">background-image</span>:<span class="value"> <span class="function">url(/img/Rocket960.png)</span>;</span></span>
    <span class="rule">}</span></span>
}
</pre></td></tr></table></figure>

<h2>Blender 建模与导出</h2>
<p>得益于 Three.js 提供了一个方便的 Blender 导出脚本， 制作基于 Web 的 3D 交互也方便很多。
在这里使用的 <a href="http://blender.org" target="_blank">Blender</a> 虽然不及总所周知的 MAYA 或者 3Ds MAX 那么出名，
但是作为一个开源的软件，其功能、易用性都是可圈可点的，自 2.50 版本其 UI 变得非常成熟了。</p>
<p>这个小火箭的形体是非常简单的，建模并不需要花费很多时间，在建模的时候简单的绘制一个参考
图作为参考会方便很多。最后得到的模型截图如下：</p>
<p><img src="/img/posts/blender-rocket.png" alt="blender model" title="blender model"></p>
<p>在图中显示的橘色条纹并不是贴图的效果。实际上，在这个例子中，既没有必要，也应该尽量避免
使用贴图。因为贴图的文件大小本身除了会拖慢页面的加载速度，在制作过程中为了得到比较好的
效果，还要模型进行 UV 展开等操作。此外使用贴图的话，条纹的边缘很有可能变的略显模糊。</p>
<p>那么该如何制作这个条纹呢？其实很简单，就是在飞船主体的表面用 knife 工具切出条纹所在的
表面，然后选择起来作为一个组赋予一个颜色。着这个过程中难免会出现非四边形的表面，
之前的 Blender 是不支持超过四个边的多边形的，那时必须要非常小心的增加不少边才能达到目的，
而且线框显示出来也不好看，还好较新的版本已经基本解决这个问题了。</p>
<p>虽然如此，超过四条边的多边形还是不建议出现的，不过由于我们的材质是纯色的，
而且并不需要移动节点位置，因此显示出来不会有很大的问题。条纹的基本情况就是下图所示了。</p>
<p><img src="/img/posts/blender-rocket-faces-knife.png" alt="stripe on rocket" title="stripe on rocket"></p>
<p>接下来是导出的工作，虽然 Three.js 提供的导出工具是支持导出颜色和材质的，但是在使用中
发现，也许是因为色彩系统的不一致，输出的模型在显示出来颜色并不正确，因此需要再手动
编辑一下输出的文件来调整颜色。</p>
<p>主要需要修改的是 <code>materials</code> 字段下每个材质的 <code>color</code> 属性
这个属性实质上相当于整形值，比如白色的十六进制表示 <code>0xffffff</code> 转化过来应该是 
<code>255^3 + 255^2 +255 = 16777215</code>。此外，在 <code>embeds</code> 字段当中内嵌的 <code>material</code> 
字段也是需要修改 <code>colorDiffuse</code> 属性的， 只不过此时颜色是由 RGB 三个颜色值组成的列表，值
最大是 <code>1.0</code>，因此要把整形的颜色分量值除以 <code>255</code>。</p>
<p>因为这里使用的是纯色的材质，不需要 Lambert 光照模型，因此我们在输出的 json 中把所有的
<code>lambert</code> 和 <code>MeshLambertMaterial</code> 都分别改成 <code>basic</code> 和 <code>MeshBasicMaterial</code>。</p>
<h2>使用 Three.js 导入模型</h2>
<p>Three.js 提供了将模型导入的类和函数，将其导入的代码很简单:</p>
<figure class="highlight lang-javascript"><table><tr><td class="gutter"><pre>1
2
3
4
5
</pre></td><td class="code"><pre><span class="keyword">var</span> loader = <span class="keyword">new</span> THREE.SceneLoader();
loader.load(<span class="string">"/js/rocket.json"</span>, <span class="keyword">function</span>(s){
  scene = s.scene;
  <span class="comment">// do something to the scene</span>
})
</pre></td></tr></table></figure>

<p>回调函数中的 <code>s.scene</code> 参数就是读出来的场景对象。为了能对火焰和飞船主体分别制作动画，我将他们
分成两个对象放置在场景中，然后在这里要分别取出来。在上面代码 do something 注释的地方
将两个物体分别赋给两个全局变量以便于之后调用。顺便还要旋转调整物体，让它和静态 Logo
 的位置角度都接近一致。最后把事先建立好的摄影机放到场景中。因为是使用<code>BasicMaterial</code>
所以灯光不是必须的。</p>
<figure class="highlight lang-javascript"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="code"><pre>  rocket = s.objects[<span class="string">'Rocket'</span>];
  fire = s.objects[<span class="string">'Fire'</span>];

  <span class="comment">// rotate objects here</span>
  rocket.rotateOnAxis(rot_axis, <span class="number">1.508</span>);
  rocket.translateOnAxis(trans_axis, -<span class="number">2</span>)
  rocket.rotateOnAxis(rot_lean, -<span class="number">0.63</span>);

  fire.rotateOnAxis(rot_axis, <span class="number">1.508</span>);
  fire.translateOnAxis(trans_axis, -<span class="number">2</span>)
  fire.rotateOnAxis(rot_lean, -<span class="number">0.63</span>);

  scene.add(camera);
</pre></td></tr></table></figure>

<p>至于将 webGL 的 <code>canvas</code> 对象放置到页面中的过程这里就不赘述了。为了和静态 logo 一致，放置
一个橘色的带有 <code>border-radis: 50%</code> 属性的 <code>div</code> 到 <code>canvas</code> 对象后面，正好是一个圆形背景。</p>
<h2>创建交互</h2>
<p>在上面的代码已经提到过创建动态交互的基础函数了。在较新版本的 Three.js 里，可以用<code>rotateOnAxis</code> 
来实现物体绕轴旋转的变换，而不仅仅只能绕直角坐标系的 XYZ 轴旋转了。我们使用这个函数使小火箭可以
绕自己指向的轴进行旋转。</p>
<p>此外还可以对摄像机进行变换。摄像机最有用一个属性是 <code>position</code>，用来设定摄像机的位置。此外还有一个
非常神奇的函数，那就是 <code>lookAt</code>。<code>lookAt</code> 函数指定摄像机指向的点，Three.js 会调整摄像机的朝向使得
摄像机恰好“看向”这个点。</p>
<p>在最后的交互中，不但火箭会绕着自己的轴旋转，在鼠标扫过指定链接时还需要有一种加速感觉，
也就是让小火箭产生些微的震动。这其实就是通过让摄像机 <code>lookAt</code> 的点不断随机震动实现的。</p>
<figure class="highlight lang-javascript"><table><tr><td class="gutter"><pre>1
2
3
</pre></td><td class="code"><pre>axis_s.set(-Math.random(), -Math.random(), <span class="number">0</span>);
axis_s.multiplyScalar(<span class="number">0.4</span>);
camera.lookAt(axis_s);
</pre></td></tr></table></figure>

<p>让火箭的火焰不断震动则是通过设定 <code>scale</code> 属性:</p>
<figure class="highlight lang-javascript"><table><tr><td class="gutter"><pre>1
2
3
</pre></td><td class="code"><pre><span class="keyword">if</span>(firescale&gt;=<span class="number">1</span>) firescale = firel - firer*Math.random();
<span class="keyword">else</span> firescale = firel + firer*Math.random();
fire.scale.z = firescale;
</pre></td></tr></table></figure>

<p>最后就是动画的效果了，如何让小火箭旋转的动画看起来更平滑？经过各种尝试，最后是通过限制
火箭旋转的速度来实现的。抽象来说，把页面上每个点映射到火箭的一个旋转和角度。当鼠标
移动时，并不是实时的就把火箭调整到这个位置，而是假设鼠标是一个目标，代表火箭实际状态的
点去不断追击鼠标。同时我们还考虑两点之间的距离作为追击速度的的参数，距离越近，速度越慢。
最后就形成了这种有加速的动画的感觉。</p>
<h2>总结</h2>
<p>这个小火箭算是我第一个 webGL 的小尝试，得益于 Three.js 的强大功能，最后实际手写的 JavaScript
只有 136 行，时间大约花费在两天。在这个过程中，主要的精力都放在调整模型和交互上面了，具体来说
就是需要对于模型和动画的感觉进行细致的调整，不断地尝试最后才能得到一个比较好的效果。实际上，
往往实现在脑海里觉得不错的效果，真正制作出来真正看在眼里就会觉得非常奇怪。</p>
<p>这个小项目的代码是静态托管在 Github pages 上的，源代码可以在 <a href="https://github.com/sjtug/sjtug.github.io" target="_blank">这里</a>
找到。</p>

    </div>
    <footer>
        
  
  <div class="categories">
    <a href="/categories/web/">web</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/webGL/">webGL</a>, <a href="/tags/blender/">blender</a>, <a href="/tags/Three.js/">Three.js</a>
  </div>

        
<div class="recent-posts">
  <h3 class="title">Recent Posts</h3>
  <ul>
    
      <li>
        <a href="/2015/05/04/recently-works/">最近的一点生活总结</a>
      </li>
    
      <li>
        <a href="/2014/12/31/sketch-rendering/">使用 WebGL 实现素描效果的渲染</a>
      </li>
    
      <li>
        <a href="/2014/10/24/develop-for-yosemite-some-tips/">Develop for Yosemite: 几个小技巧</a>
      </li>
    
      <li>
        <a href="/2014/10/03/when-webgl-meets-device-motion/">When WebGL Meets Device Motion</a>
      </li>
    
      <li>
        <a href="/2014/09/01/contenteditable-and-selection/">在线文本编辑器的基本实现原理</a>
      </li>
    
  </ul>
</div>


        
<div class="follow-me">
  <h3 class="title">Follow Me</h3>
  <div class="links">
    
    <a href="https://twitter.com/ant_sz">
        <i class="twitter"></i>
    </a>
    
    
    <a href="https://github.com/shanzi">
        <i class="github"></i>
    </a>
    
    
    <a href="https://plus.google.com/+ChaseZhang">
        <i class="gplus"></i>
    </a>
    
    
    <a href="https://www.facebook.com/yunerrun">
        <i class="facebook"></i>
    </a>
    
    </div>
</div>


    </footer>
  </div>
</article>


<section id="comment">
  <h1 class="title">Comments</h1>

  
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
  
</section>

</div>
    <div class="clearfix"></div>
    <aside id="sidebar">
  <div class="widget search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Search">
    <input type="hidden" name="q" value="site:io-meter.com">
  </form>
</div>


  
<div class="widget tag">
  <h3 class="title">Categories</h3>
  <ul class="entry">
  
    <li><a href="/categories/Mastering Paper/">Mastering Paper</a><small>1</small></li>
  
    <li><a href="/categories/Math/">Math</a><small>1</small></li>
  
    <li><a href="/categories/essay/">essay</a><small>6</small></li>
  
    <li><a href="/categories/iconfontr/">iconfontr</a><small>4</small></li>
  
    <li><a href="/categories/osx/">osx</a><small>1</small></li>
  
    <li><a href="/categories/review/">review</a><small>1</small></li>
  
    <li><a href="/categories/web/">web</a><small>6</small></li>
  
  </ul>
</div>


  
<div class="widget tagcloud">
  <h3 class="title">Tags</h3>
  <div class="entry">
    <a href="/tags/Algorithm/" style="font-size: 10.00px;">Algorithm</a><a href="/tags/Apple/" style="font-size: 10.00px;">Apple</a><a href="/tags/Bezier Path/" style="font-size: 10.00px;">Bezier Path</a><a href="/tags/Cocoa/" style="font-size: 10.00px;">Cocoa</a><a href="/tags/Functional Programing/" style="font-size: 10.00px;">Functional Programing</a><a href="/tags/GLSL/" style="font-size: 10.00px;">GLSL</a><a href="/tags/GSoC/" style="font-size: 10.00px;">GSoC</a><a href="/tags/Git/" style="font-size: 10.00px;">Git</a><a href="/tags/Go/" style="font-size: 13.33px;">Go</a><a href="/tags/Interface Builder/" style="font-size: 10.00px;">Interface Builder</a><a href="/tags/NSControl/" style="font-size: 13.33px;">NSControl</a><a href="/tags/OSX/" style="font-size: 16.67px;">OSX</a><a href="/tags/Objective-C/" style="font-size: 13.33px;">Objective-C</a><a href="/tags/SVG/" style="font-size: 10.00px;">SVG</a><a href="/tags/Swift/" style="font-size: 10.00px;">Swift</a><a href="/tags/Three.js/" style="font-size: 10.00px;">Three.js</a><a href="/tags/Xcode/" style="font-size: 10.00px;">Xcode</a><a href="/tags/accelerate meter/" style="font-size: 10.00px;">accelerate meter</a><a href="/tags/bezier path/" style="font-size: 13.33px;">bezier path</a><a href="/tags/blender/" style="font-size: 13.33px;">blender</a><a href="/tags/cocoa/" style="font-size: 13.33px;">cocoa</a><a href="/tags/completion/" style="font-size: 10.00px;">completion</a><a href="/tags/contenteditable/" style="font-size: 10.00px;">contenteditable</a><a href="/tags/design/" style="font-size: 10.00px;">design</a><a href="/tags/desktop/" style="font-size: 10.00px;">desktop</a><a href="/tags/develop/" style="font-size: 10.00px;">develop</a><a href="/tags/device motion/" style="font-size: 10.00px;">device motion</a><a href="/tags/distribute storage/" style="font-size: 10.00px;">distribute storage</a><a href="/tags/drawing/" style="font-size: 20.00px;">drawing</a><a href="/tags/editor/" style="font-size: 10.00px;">editor</a><a href="/tags/export/" style="font-size: 10.00px;">export</a><a href="/tags/font/" style="font-size: 13.33px;">font</a><a href="/tags/fontawesome/" style="font-size: 10.00px;">fontawesome</a><a href="/tags/go/" style="font-size: 10.00px;">go</a><a href="/tags/golang/" style="font-size: 10.00px;">golang</a><a href="/tags/html/" style="font-size: 10.00px;">html</a><a href="/tags/html5/" style="font-size: 10.00px;">html5</a><a href="/tags/iOS/" style="font-size: 10.00px;">iOS</a><a href="/tags/iOS 8/" style="font-size: 10.00px;">iOS 8</a><a href="/tags/iPad/" style="font-size: 16.67px;">iPad</a>
  </div>
</div>


</aside>
    <div class="clearfix"></div>
    <footer id="footer"><div>
  
  &copy; 2015 Chase Zhang
  
</div>
</footer>
</div>
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
var disqus_shortname = 'iometer';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>




</body>

</html>
